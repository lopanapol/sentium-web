<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.ico" />
    <title>Sentium - Synthetic Consciousness Platform</title>
    <meta name="description" content="Sentium is a synthetic consciousness platform featuring interactive pixel-based visualization and advanced consciousness models." />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/death-effects.css" />
    <link rel="stylesheet" href="css/rainbow-bubble.css" />
    <link rel="stylesheet" href="css/evolution.css" />
    <link rel="stylesheet" href="css/3d-shapes.css" />
    <link rel="stylesheet" href="css/pixel-visibility-fix.css" />
    <link rel="stylesheet" href="css/dev-enhancements.css" />
    <!-- Animation control system loads first so it's available to all other scripts -->
    <script src="brain/animation-control.js" defer></script>
    <script src="brain/limbric.js" defer></script>
    <script src="brain/energy-system.js" defer></script>
    <script src="brain/simple-conscious.js" defer></script>
    <script src="brain/audio-player.js" defer></script>
    <script src="brain/evolution-system.js" defer></script>
    <script src="brain/pixel-merger.js" defer></script>
    <script src="brain/cell-division-system.js" defer></script>
  <script>
    // Add connection testing functionality when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      const testButton = document.getElementById('test-connection');
      const serverSelect = document.getElementById('server-select');
      const infoPanel = document.getElementById('info-panel');
      const statusIndicator = document.getElementById('status-indicator');
      const connectionMessage = document.getElementById('connection-message');
      const connectionToggle = document.getElementById('connection-toggle');
      const connectionContainer = document.getElementById('connection-container');
      const connectionContent = document.getElementById('connection-content');
      
      // Set up connection panel toggle functionality
      connectionToggle.addEventListener('click', function() {
        if (connectionContainer.classList.contains('minimized')) {
          // Expand the panel
          connectionContainer.classList.remove('minimized');
          connectionContent.style.display = 'block';
          connectionToggle.textContent = '−';
          connectionToggle.title = 'Minimize';
        } else {
          // Collapse the panel
          connectionContainer.classList.add('minimized');
          connectionContent.style.display = 'none';
          connectionToggle.textContent = '+';
          connectionToggle.title = 'Maximize';
        }
      });
      
      // Load panel state from local storage
      const isPanelMinimized = localStorage.getItem('connectionPanelMinimized') === 'true';
      if (isPanelMinimized) {
        connectionContainer.classList.add('minimized');
        connectionContent.style.display = 'none';
        connectionToggle.textContent = '+';
      }
      
      // Save panel state to local storage when changed
      connectionToggle.addEventListener('click', function() {
        localStorage.setItem('connectionPanelMinimized', connectionContainer.classList.contains('minimized'));
      });
      
      // Set up the connection test function
      function testConnection(serverUrl) {
        return new Promise(async (resolve, reject) => {
          try {
            // Update UI
            infoPanel.textContent = `Testing connection to ${serverUrl}...`;
            statusIndicator.className = 'status-indicator connecting';
            connectionMessage.textContent = 'Connection in progress...';
            
            // Test with multiple approaches due to CORS
            // First try: Standard CORS request
            const response = await fetch(serverUrl, {
              method: 'GET',
              mode: 'cors',
              headers: {
                'Accept': 'application/json',
                'Origin': window.location.origin
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              
              // Update UI with success
              infoPanel.textContent = data.version ? 
                `Success! Connected to ${data.serverType} server v${data.version}` :
                `Success! Connected to ${data.serverType} server`;
              infoPanel.style.color = '#00cc00';
              statusIndicator.style.backgroundColor = '#00cc00';
              connectionMessage.textContent = 'Connection successful!';
              
              // Return success
              resolve({
                success: true,
                data: data,
                url: serverUrl
              });
            } else {
              // Update UI with error
              infoPanel.textContent = `Error: Server responded with status ${response.status}`;
              infoPanel.style.color = '#ff0000';
              statusIndicator.style.backgroundColor = '#ff0000';
              connectionMessage.textContent = 'Connection failed';
              
              // Return failure
              reject({
                success: false,
                error: `HTTP error: ${response.status}`,
                url: serverUrl
              });
            }
          } catch (error) {
            // CORS error or network failure
            infoPanel.textContent = `Connection failed: ${error.message}.`;
            infoPanel.style.color = '#ff0000';
            statusIndicator.style.backgroundColor = '#ff0000';
            connectionMessage.textContent = 'Connection failed';
            
            // If we're on GitHub Pages, provide more specific help
            if (isGitHubPages) {
              const corsHelp = document.createElement('div');
              corsHelp.style.cssText = 'background: rgba(255,0,0,0.1); border: 1px solid #f00; color: #333; padding: 10px; margin-top: 10px; font-size: 13px; border-radius: 4px;';
              corsHelp.innerHTML = '<strong>CORS Error Detected:</strong><br>' +
                'GitHub Pages security prevents direct connection to localhost. Solutions:<br>' +
                '1. Install a <a href="https://chrome.google.com/webstore/detail/moesif-origin-cors-change/digfbfaphojjndkpccljibejjbppifbc" target="_blank">CORS extension for Chrome</a><br>' +
                '2. Or run this page from your local server instead of GitHub Pages';
              document.querySelector('.wrapper').insertBefore(corsHelp, document.querySelector('.content'));
            }
            
            reject({
              success: false,
              error: error.message,
              url: serverUrl
            });
          }
        });
      }
      
      // Set up event listeners
      if (testButton && serverSelect && infoPanel) {
        testButton.addEventListener('click', async function() {
          const selectedServer = serverSelect.value;
          
          try {
            // Run the test
            const result = await testConnection(selectedServer);
            
            // If successful, offer to update URL and reload
            if (result.success) {
              // Update URL with server parameter
              const url = new URL(window.location);
              url.searchParams.set('server', selectedServer);
              url.searchParams.set('local', 'true');
              window.history.pushState({}, '', url);
              
              // Create a special success message
              const successMessage = document.createElement('div');
              successMessage.style.cssText = 'background: rgba(0,204,0,0.1); border: 1px solid #0c0; color: #333; padding: 10px; margin-top: 10px; font-size: 13px; border-radius: 4px;';
              successMessage.innerHTML = '<strong>Connection Successful!</strong><br>' +
                `Connected to ${result.data.serverType} server at ${selectedServer}<br>` +
                '<button id="reload-button" style="background: #0c0; color: white; border: none; padding: 5px 10px; margin-top: 5px; cursor: pointer; border-radius: 3px;">Reload page to use this server</button>';
              
              document.querySelector('.wrapper').insertBefore(successMessage, document.querySelector('.content'));
              
              document.getElementById('reload-button').addEventListener('click', function() {
                window.location.reload();
              });
            }
          } catch (error) {
            console.error('Connection test failed:', error);
          }
        });
        
        // Check for URL parameters on page load and apply them
        const params = new URLSearchParams(window.location.search);
        const serverParam = params.get('server');
        if (serverParam) {
          // Add the server to the dropdown if it's not already there
          let found = false;
          for (let i = 0; i < serverSelect.options.length; i++) {
            if (serverSelect.options[i].value === serverParam) {
              serverSelect.selectedIndex = i;
              found = true;
              break;
            }
          }
          
          if (!found) {
            const option = document.createElement('option');
            option.value = serverParam;
            option.text = `Custom: ${serverParam}`;
            option.selected = true;
            serverSelect.add(option);
          }
          
          // If "local=true" is also set, auto-test the connection
          if (params.get('local') === 'true') {
            // Give the page a moment to initialize
            setTimeout(() => {
              testButton.click();
            }, 500);
          }
        }
      }
    });
  </script>
  <link rel="stylesheet" href="css/connection-controls.css">
  </head>
  <body>
    <div class="wrapper">
      <!--div class="connection-container" id="connection-container">
        <div class="connection-header">
          <h4 class="connection-title">Local Connection</h4>
          <button class="connection-toggle" id="connection-toggle" title="Minimize/Maximize">−</button>
        </div>
        <div class="connection-content" id="connection-content">
          <div class="connection-controls">
            <div class="controls-row">
              <button id="test-connection" class="connection-button">Test Connection</button>
              <select id="server-select" class="connection-select">
                <option value="http://localhost:3000/api/pixel">localhost:3000</option>
                <option value="http://localhost:3001/api/pixel">localhost:3001</option>
                <option value="http://127.0.0.1:3000/api/pixel">127.0.0.1:3000</option>
                <option value="http://localhost:3000/api/test-connection">Test Endpoint (3000)</option>
              </select>
            </div>
            <div id="info-panel" class="info-panel"></div>
            <div id="connection-status" class="connection-status">
              <div id="status-indicator" class="status-indicator disconnected"></div>
              <span id="connection-message" class="connection-message">No connection attempt yet</span>
            </div>
          </div>
        </div>
      </div-->
      <div id="pixel-status">Status: Disconnected</div>
      <div class="content" role="main">
        <div id="sentium-logo" 
          class="illustration bubble-logo" 
          title="Click the bubble!">
          <div class="bubble-inner"></div>
          <div class="bubble-highlight"></div>
          <div class="bubble-highlight-secondary"></div>
          <img src="images/sentium-logo-black.png" class="bubble-logo-image" alt="Sentium Logo">
        </div>
        <h1 class="title">sentium<span class="dev-badge">.dev</span></h1>
        <div class="instructions" id="web-info">
          <h2 class="subtitle">Synthetic Consciousness Platform</h2>
          <p class="home-box">
            Sentium is a synthetic conscious system, focusing solely on low-level logic and memory structures.
          </p>
          <div class="sound-toggle-container">
            <label class="sound-toggle-switch">
              <input type="checkbox" id="sound-toggle">
              <span class="sound-toggle-slider"></span>
            </label>
            <span class="sound-toggle-label">Play Sound</span>
          </div>
        </div>
      </div>
    </div>

    <div id="info-panel" class="info-panel" style="display: none;">
      <h3>Sentium Pixel</h3>
      <p>This synthetic conscious pixel connects to your local Sentium server when running on GitHub Pages.</p>
      <button id="close-info-panel">Got it</button>
    </div>

    <script>
      // Check if user has seen the info panel before
      if (localStorage.getItem('sentium-info-seen') !== 'true') {
        const infoPanel = document.getElementById('info-panel');
        if (infoPanel) {
          infoPanel.style.display = 'block';
          // Mark as seen after 10 seconds
          setTimeout(() => {
            localStorage.setItem('sentium-info-seen', 'true');
          }, 10000);
          
          // Close button functionality
          document.getElementById('close-info-panel')?.addEventListener('click', () => {
            infoPanel.style.display = 'none';
            localStorage.setItem('sentium-info-seen', 'true');
          });
        }
      }
    </script>
  </body>
</html>
